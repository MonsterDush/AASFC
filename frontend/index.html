<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Telegram SDK: ВАЖНО defer -->
  <script defer src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Твой скрипт: тоже defer -->
  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const out = document.getElementById("out");
      const API = "https://api-dev.axelio.ru";

      function log(s) { out.textContent = s; }

      async function login() {
        try {
          const wa = window.Telegram?.WebApp;
          const initData = wa?.initData || "";
          log("initData length: " + initData.length);

          if (!initData) {
            log("NO initData. Open via Telegram Mini App button.");
            return;
          }

          const r = await fetch(`${API}/auth/telegram`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ initData }),
          });

          log(`LOGIN ${r.status}\n` + await r.text());
        } catch (e) {
          log("LOGIN ERROR: " + (e?.message || String(e)));
        }
      }

      async function me() {
        try {
          const r = await fetch(`${API}/me`, { credentials: "include" });
          log(`ME ${r.status}\n` + await r.text());
        } catch (e) {
          log("ME ERROR: " + (e?.message || String(e)));
        }
      }

      async function createVenue() {
        try {
          const r = await fetch(`${API}/venues`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ name: "Test Venue" }),
          });
          log(`CREATE VENUE ${r.status}\n` + await r.text());
        } catch (e) {
          log("CREATE ERROR: " + (e?.message || String(e)));
        }
      }

      async function health() {
        try {
          const r = await fetch(`${API}/health`, { credentials: "include" });
          log(`HEALTH ${r.status}\n` + await r.text());
        } catch (e) {
          log("HEALTH ERROR: " + (e?.message || String(e)));
        }
      }

      // Вешаем обработчики ТОЛЬКО после загрузки DOM
      document.getElementById("btn-health").addEventListener("click", health);
      document.getElementById("btn-login").addEventListener("click", login);
      document.getElementById("btn-me").addEventListener("click", me);
      document.getElementById("btn-create-venue").addEventListener("click", createVenue);

      // Лёгкая диагностика
      const wa = window.Telegram?.WebApp;
      log(
        "Telegram.WebApp: " + !!wa + "\n" +
        "initData length: " + (wa?.initData?.length || 0)
      );
    });
  </script>
</head>

<body>
    <button id="btn-health">0) Health</button>
    <button id="btn-login">11) Login</button>
    <button id="btn-me">2) Me</button>
    <button id="btn-create-venue">3) Create venue</button>
    <pre id="out"></pre>
</body>
</html>
