<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script defer src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>Invites & Members</title>

  <style>
    :root{--bg:#0b1220;--card:#111a2e;--text:#e6e8ee;--muted:#aab1c5;--accent:#5b8cff;--accentText:#0b1220;--danger:#ff5b5b;--border:rgba(255,255,255,.10);--shadow:0 10px 30px rgba(0,0,0,.35);--radius:16px;--mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;--sans:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);background:var(--bg);color:var(--text);padding:18px 14px 22px}
    .container{max-width:920px;margin:0 auto}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,var(--accent),rgba(255,255,255,.15));box-shadow:var(--shadow)}
    .title{line-height:1.1}
    .title b{font-size:16px}
    .title div{font-size:12px;color:var(--muted)}
    .userpill{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.04);font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:0;cursor:pointer;padding:11px 12px;border-radius:12px;background:rgba(255,255,255,.08);color:var(--text);border:1px solid var(--border);font-weight:600}
    .btn.primary{background:var(--accent);color:var(--accentText);border-color:transparent}
    .btn.danger{background:rgba(255,91,91,.12);border-color:rgba(255,91,91,.35);color:#ffd1d1}
    .btn:active{transform:translateY(1px)}
    a.link{color:var(--accent);text-decoration:none;font-weight:600}
    input, select{padding:10px 10px;border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.18);color:var(--text)}
    input{min-width:240px}
    select{min-width:140px}
    .muted{color:var(--muted);font-size:13px;line-height:1.35}
    .cols{display:grid;grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px}
    @media (max-width:860px){ .cols{grid-template-columns:1fr;} }
    .box{border:1px solid var(--border);border-radius:14px;padding:14px;background:rgba(255,255,255,.03)}
    .item{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
    .item:last-child{border-bottom:0}
    .mono{font-family:var(--mono);font-size:12px;color:var(--muted)}
    .out{margin-top:12px;padding:12px;border-radius:12px;background:rgba(0,0,0,.22);border:1px solid var(--border);font-family:var(--mono);font-size:12px;white-space:pre-wrap;max-height:220px;overflow:auto}
  </style>

  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const API = "https://api-dev.axelio.ru";
      const out = document.getElementById("out");
      const userpill = document.getElementById("userpill");
      const venueMeta = document.getElementById("venueMeta");
      const pendingBox = document.getElementById("pending");
      const membersBox = document.getElementById("members");

      const params = new URLSearchParams(location.search);
      const venueId = params.get("venue_id");
      venueMeta.textContent = venueId ? `venue_id=${venueId}` : "venue_id not provided";

      const wa = window.Telegram?.WebApp;
      if (wa) {
        wa.ready();
        const t = wa.themeParams || {};
        const set = (k,v)=>document.documentElement.style.setProperty(k, v);
        if (t.bg_color) set("--bg", t.bg_color);
        if (t.secondary_bg_color) set("--card", t.secondary_bg_color);
        if (t.text_color) set("--text", t.text_color);
        if (t.hint_color) set("--muted", t.hint_color);
        if (t.button_color) set("--accent", t.button_color);
        if (t.button_text_color) set("--accentText", t.button_text_color);

        const u = wa.initDataUnsafe?.user;
        userpill.textContent = u ? `@${u.username || "no_username"}` : "unknown";
      }

      function log(s){ out.textContent = s; }
      function pretty(x){ try { return JSON.stringify(x, null, 2); } catch { return String(x); } }

      async function api(path, opts={}) {
        const r = await fetch(API + path, {
          ...opts,
          credentials:"include",
          headers:{ "Content-Type":"application/json", ...(opts.headers||{}) },
        });
        const text = await r.text();
        let data; try{ data = JSON.parse(text); } catch{ data = text; }
        if(!r.ok) throw new Error(typeof data==="string" ? data : pretty(data));
        return data;
      }

      async function login(){
        const initData = wa?.initData || "";
        if (!initData) { log("NO initData. Открой через Telegram."); return; }
        const data = await api("/auth/telegram", { method:"POST", body: JSON.stringify({ initData }) });
        log("LOGIN OK\n" + pretty(data));
      }

      function renderPending(items){
        pendingBox.innerHTML = "";
        if (!items?.length) {
          pendingBox.innerHTML = `<div class="muted">Нет ожидающих приглашений</div>`;
          return;
        }
        items.forEach(i => {
          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div>
              <div><b>@${i.tg_username}</b> <span class="mono">role=${i.venue_role}</span></div>
              <div class="mono">${i.created_at || ""}</div>
            </div>
            <button class="btn danger" data-cancel>Cancel</button>
          `;
          row.querySelector("[data-cancel]").onclick = async () => {
            await api(`/venues/${venueId}/invites/${i.id}`, { method:"DELETE" });
            await load();
          };
          pendingBox.appendChild(row);
        });
      }

      function renderMembers(items){
        membersBox.innerHTML = "";
        if (!items?.length) {
          membersBox.innerHTML = `<div class="muted">Пока нет участников</div>`;
          return;
        }
        items.forEach(m => {
          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div>
              <div><b>@${m.tg_username || "-"}</b> <span class="mono">role=${m.venue_role}</span></div>
              <div class="mono">user_id=${m.user_id} · tg_user_id=${m.tg_user_id || "-"}</div>
            </div>
          `;
          membersBox.appendChild(row);
        });
      }

      async function load(){
        if (!venueId) { log("No venue_id in URL"); return; }
        const data = await api(`/venues/${venueId}/members`);
        renderPending(data.pending_invites);
        renderMembers(data.members);
        log("Loaded members & invites");
      }

      document.getElementById("btn-login").onclick = () => login().catch(e => log("LOGIN ERROR: " + e.message));
      document.getElementById("btn-reload").onclick = () => load().catch(e => log("LOAD ERROR: " + e.message));
      document.getElementById("btn-invite").onclick = async () => {
        try {
          const tg = document.getElementById("tg").value.trim();
          const role = document.getElementById("role").value;
          await api(`/venues/${venueId}/invites`, {
            method:"POST",
            body: JSON.stringify({ tg_username: tg, venue_role: role })
          });
          document.getElementById("tg").value = "";
          await load();
        } catch (e) {
          log("INVITE ERROR: " + e.message);
        }
      };

      log("Invites & Members\nНажми Login (если нужно), затем Reload.");
      load().catch(e => log("LOAD ERROR: " + e.message));
    });
  </script>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <b>Invites & Members</b>
          <div><a class="link" href="/owners.html">← Back</a></div>
        </div>
      </div>
      <div class="userpill">
        <span id="venueMeta"></span> · <span id="userpill">…</span>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button class="btn primary" id="btn-login">Login</button>
        <button class="btn" id="btn-reload">Reload</button>
      </div>

      <div class="box" style="margin-top:12px">
        <div class="row">
          <input id="tg" placeholder="tg username (owner/staff)" />
          <select id="role">
            <option value="STAFF">STAFF</option>
            <option value="OWNER">OWNER</option>
          </select>
          <button class="btn primary" id="btn-invite">Invite</button>
        </div>
        <div class="muted" style="margin-top:8px">
          Username можно вводить с @ или без — мы нормализуем на бэке.
        </div>
      </div>

      <div class="cols">
        <div class="box">
          <b>Pending invites</b>
          <div id="pending" style="margin-top:8px"></div>
        </div>
        <div class="box">
          <b>Members</b>
          <div id="members" style="margin-top:8px"></div>
        </div>
      </div>

      <div id="out" class="out"></div>
    </div>
  </div>
</body>
</html>
